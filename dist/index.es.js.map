{"version":3,"file":"index.es.js","sources":["../src/Storage.js","../src/Entity.js","../src/Serialize.js","../src/Query.js","../src/Component.js","../src/World.js","../src/System.js","../src/index.js"],"sourcesContent":["export const TYPES_ENUM = {\n  bool: 'bool',\n  i8: 'i8',\n  ui8: 'ui8',\n  ui8c: 'ui8c',\n  i16: 'i16',\n  ui16: 'ui16',\n  i32: 'i32',\n  ui32: 'ui32',\n  f32: 'f32',\n  f64: 'f64'\n}\n\nexport const TYPES_NAMES = {\n  bool: 'Uint8',\n  i8: 'Int8',\n  ui8: 'Uint8',\n  ui8c: 'Uint8Clamped',\n  i16: 'Int16',\n  ui16: 'Uint16',\n  i32: 'Int32',\n  ui32: 'Uint32',\n  f32: 'Float32',\n  f64: 'Float64'\n}\n\nexport const TYPES = {\n  bool: 'bool',\n  i8: Int8Array,\n  ui8: Uint8Array,\n  ui8c: Uint8ClampedArray,\n  i16: Int16Array,\n  ui16: Uint16Array,\n  i32: Int32Array,\n  ui32: Uint32Array,\n  f32: Float32Array,\n  f64: Float64Array\n}\n\nconst UNSIGNED_MAX = {\n  uint8: 2**8,\n  uint16: 2**16,\n  uint32: 2**32\n}\n\nconst roundToMultiple4 = x => Math.ceil(x / 4) * 4\n\nexport const $storeRef = Symbol('storeRef')\nexport const $storeSize = Symbol('storeSize')\nexport const $storeMaps = Symbol('storeMaps')\nexport const $storeFlattened = Symbol('storeFlattened')\nexport const $storeBase = Symbol('storeBase')\n\nexport const $storeArrayCount = Symbol('storeArrayCount')\nexport const $storeSubarrays = Symbol('storeSubarrays')\nexport const $storeCursor = Symbol('storeCursor')\nexport const $subarrayCursors = Symbol('subarrayCursors')\nexport const $subarray = Symbol('subarray')\n\nexport const $queryShadow = Symbol('queryShadow')\nexport const $serializeShadow = Symbol('serializeShadow')\n\nexport const $indexType = Symbol('indexType')\nexport const $indexBytes = Symbol('indexBytes')\n\nconst stores = {}\n\nexport const resize = (ta, size) => {\n  const newBuffer = new ArrayBuffer(size * ta.BYTES_PER_ELEMENT)\n  const newTa = new ta.constructor(newBuffer)\n  newTa.set(ta, 0)\n  return newTa\n}\n\nconst resizeRecursive = (store, size) => {\n  Object.keys(store).forEach(key => {\n    const ta = store[key]\n    if (ta[$subarray]) return\n    else if (ArrayBuffer.isView(ta)) {\n      store[key] = resize(ta, size)\n      store[key][$queryShadow] = resize(ta[$queryShadow], size)\n      store[key][$serializeShadow] = resize(ta[$serializeShadow], size)\n    } else if (typeof ta === 'object') {\n      resizeRecursive(store[key], size)\n    }\n  })\n}\n\nconst resizeSubarrays = (store, size) => {\n  const cursors = store[$subarrayCursors] = {}\n  Object.keys(store[$storeSubarrays]).forEach(type => {\n    const arrayCount = store[$storeArrayCount]\n    const length = store[0].length\n    const summedBytesPerElement = Array(arrayCount).fill(0).reduce((a, p) => a + TYPES[type].BYTES_PER_ELEMENT, 0)\n    const summedLength = Array(arrayCount).fill(0).reduce((a, p) => a + length, 0)\n    const buffer = new ArrayBuffer(roundToMultiple4(summedBytesPerElement * summedLength * size))\n    const array = new TYPES[type](buffer)\n\n    array.set(store[$storeSubarrays][type].buffer, 0)\n\n    store[$storeSubarrays][type] = array\n    store[$storeSubarrays][type][$queryShadow] = array.slice(0)\n    store[$storeSubarrays][type][$serializeShadow] = array.slice(0)\n\n    let end = 0\n    for (let eid = 0; eid < size; eid++) {\n      const from = cursors[type] + (eid * length)\n      const to = from + length\n      store[eid] = store[$storeSubarrays][type].subarray(from, to)\n      store[eid][$queryShadow] = store[$storeSubarrays][type][$queryShadow].subarray(from, to)\n      store[eid][$serializeShadow] = store[$storeSubarrays][type][$serializeShadow].subarray(from, to)\n      store[eid][$subarray] = true\n      store[eid][$indexType] = array[$indexType]\n      store[eid][$indexBytes] = array[$indexBytes]\n      end = to\n    }\n  })\n}\n\nexport const resizeStore = (store, size) => {\n  store[$storeSize] = size\n  resizeRecursive(store, size)\n  resizeSubarrays(store, size)\n}\n\nexport const resetStore = store => {\n  store[$storeFlattened].forEach(ta => {\n    ta.fill(0)\n  })\n  Object.keys(store[$storeSubarrays]).forEach(key => {\n    store[$storeSubarrays][key].fill(0)\n  })\n}\n\nexport const resetStoreFor = (store, eid) => {\n  store[$storeFlattened].forEach(ta => {\n    if (ArrayBuffer.isView(ta)) ta[eid] = 0\n    else ta[eid].fill(0)\n  })\n}\n\nconst createTypeStore = (type, length) => {\n  const totalBytes = length * TYPES[type].BYTES_PER_ELEMENT\n  const buffer = new ArrayBuffer(totalBytes)\n  return new TYPES[type](buffer)\n}\n\nconst createArrayStore = (store, type, length) => {\n  const size = store[$storeSize]\n  const cursors = store[$subarrayCursors]\n  const indexType =\n    length < UNSIGNED_MAX.uint8\n      ? 'ui8'\n      : length < UNSIGNED_MAX.uint16\n        ? 'ui16'\n        : 'ui32'\n\n  if (!length) throw new Error('❌ Must define a length for component array.')\n  if (!TYPES[type]) throw new Error(`❌ Invalid component array property type ${type}.`)\n\n  // create buffer for type if it does not already exist\n  if (!store[$storeSubarrays][type]) {\n    const arrayCount = store[$storeArrayCount]\n    const summedBytesPerElement = Array(arrayCount).fill(0).reduce((a, p) => a + TYPES[type].BYTES_PER_ELEMENT, 0)\n    const summedLength = Array(arrayCount).fill(0).reduce((a, p) => a + length, 0)\n    const totalBytes = roundToMultiple4(summedBytesPerElement * summedLength * size)\n    \n    const buffer = new ArrayBuffer(totalBytes)\n    const array = new TYPES[type](buffer)\n    store[$storeSubarrays][type] = array\n    store[$storeSubarrays][type][$queryShadow] = array.slice(0)\n    store[$storeSubarrays][type][$serializeShadow] = array.slice(0)\n    \n    array[$indexType] = TYPES_NAMES[indexType]\n    array[$indexBytes] = TYPES[indexType].BYTES_PER_ELEMENT\n  }\n\n  // pre-generate subarrays for each eid\n  let end = 0\n  for (let eid = 0; eid < size; eid++) {\n    const from = cursors[type] + (eid * length)\n    const to = from + length\n    store[eid] = store[$storeSubarrays][type].subarray(from, to)\n    store[eid][$queryShadow] = store[$storeSubarrays][type][$queryShadow].subarray(from, to)\n    store[eid][$serializeShadow] = store[$storeSubarrays][type][$serializeShadow].subarray(from, to)\n    store[eid][$subarray] = true\n    store[eid][$indexType] = TYPES_NAMES[indexType]\n    store[eid][$indexBytes] = TYPES[indexType].BYTES_PER_ELEMENT\n    end = to\n  }\n\n  cursors[type] = end\n\n  return store\n}\n\nconst createShadows = (store) => {\n  store[$queryShadow] = store.slice(0)\n  store[$serializeShadow] = store.slice(0)\n}\n\nconst isArrayType = x => Array.isArray(x) && typeof x[0] === 'string' && typeof x[1] === 'number'\n\nexport const createStore = (schema, size=1000000) => {\n  const $store = Symbol('store')\n\n  if (!schema) return {}\n\n  schema = JSON.parse(JSON.stringify(schema))\n\n  const collectArrayCount = (count, key) => {\n    if (isArrayType(schema[key])) {\n      count++\n    } else if (schema[key] instanceof Object) {\n      count += Object.keys(schema[key]).reduce(collectArrayCount, 0)\n    }\n    return count\n  }\n\n  const arrayCount = Object.keys(schema).reduce(collectArrayCount, 0)\n\n  const metadata = {\n    [$storeSize]: size,\n    [$storeMaps]: {},\n    [$storeSubarrays]: {},\n    [$storeRef]: $store,\n    [$storeCursor]: 0,\n    [$subarrayCursors]: Object.keys(TYPES).reduce((a, type) => ({ ...a, [type]: 0 }), {}),\n    [$storeArrayCount]: arrayCount,\n    [$storeFlattened]: []\n  }\n\n  if (schema instanceof Object && Object.keys(schema).length) {\n\n    const recursiveTransform = (a, k) => {\n      \n      if (typeof a[k] === 'string') {\n\n        a[k] = createTypeStore(a[k], size)\n        a[k][$storeBase] = () => stores[$store]\n        metadata[$storeFlattened].push(a[k])\n        createShadows(a[k])\n\n      } else if (isArrayType(a[k])) {\n        \n        const [type, length] = a[k]\n        a[k] = createArrayStore(metadata, type, length)\n        a[k][$storeBase] = () => stores[$store]\n        metadata[$storeFlattened].push(a[k])\n        // Object.freeze(a[k])\n\n      } else if (a[k] instanceof Object) {\n        \n        a[k] = Object.keys(a[k]).reduce(recursiveTransform, a[k])\n        // Object.freeze(a[k])\n        \n      }\n\n      return a\n    }\n\n    stores[$store] = Object.assign(Object.keys(schema).reduce(recursiveTransform, schema), metadata)\n    stores[$store][$storeBase] = () => stores[$store]\n\n    // Object.freeze(stores[$store])\n\n    return stores[$store]\n\n  }\n\n  stores[$store] = metadata;\n  stores[$store][$storeBase] = () => stores[$store]\n\n  return stores[$store]\n}\n\nexport const free = (store) => {\n  delete stores[store[$storeRef]]\n}","import { $componentMap } from './Component.js'\nimport { $queries, $queryMap, queryRemoveEntity } from './Query.js'\nimport { resize, resizeStore } from './Storage.js'\nimport { $size, $warningSize } from './World.js'\n\nexport const $entityMasks = Symbol('entityMasks')\nexport const $entityEnabled = Symbol('entityEnabled')\nexport const $entityArray = Symbol('entityArray')\nexport const $entityIndices = Symbol('entityIndices')\nexport const $removedEntities = Symbol('removedEntities')\n\nconst NONE = 2**32\n\n// need a global EID cursor which all worlds and all components know about\n// so that world entities can posess entire rows spanning all component tables\nlet globalEntityCursor = 0\n// removed eids should also be global to prevent memory leaks\nconst removed = []\n\nexport const resetGlobals = () => {\n  globalEntityCursor = 0\n  removed.length = 0\n}\n\nexport const getEntityCursor = () => globalEntityCursor\nexport const getRemovedEntities = () => removed\n\nexport const incrementEntityCursor = () => globalEntityCursor++\n\nexport const resizeWorld = (world, size) => {\n  world[$size] = size\n  \n  world[$componentMap].forEach(c => {\n    resizeStore(c.store, size)\n  })\n  \n  world[$queryMap].forEach(q => {\n    q.indices = resize(q.indices, size)\n    q.enabled = resize(q.enabled, size)\n  })\n  \n  world[$entityEnabled] = resize(world[$entityEnabled], size)\n  world[$entityIndices] = resize(world[$entityIndices], size)\n  \n  for (let i = 0; i < world[$entityMasks].length; i++) {\n    const masks = world[$entityMasks][i];\n    world[$entityMasks][i] = resize(masks, size)    \n  }\n}\n\nexport const addEntity = (world) => {\n  const enabled = world[$entityEnabled]\n  \n  // if data stores are 80% full\n  if (globalEntityCursor >= world[$warningSize]) {\n    // grow by half the original size rounded up to a multiple of 4\n    const size = world[$size]\n    const amount = Math.ceil((size/2) / 4) * 4\n    resizeWorld(world, size + amount)\n    world[$warningSize] = world[$size] - (world[$size] / 5)\n  }\n\n  const eid = removed.length > 0 ? removed.pop() : globalEntityCursor\n  enabled[eid] = 1\n  globalEntityCursor++\n  world[$entityIndices][eid] = world[$entityArray].push(eid) - 1\n\n  return eid\n}\n\nexport const removeEntity = (world, eid) => {\n  const enabled = world[$entityEnabled]\n\n  // Check if entity is already removed\n  if (enabled[eid] === 0) return\n\n  // Remove entity from all queries\n  // TODO: archetype graph\n  world[$queries].forEach(query => {\n    queryRemoveEntity(world, query, eid)\n  })\n\n  // Free the entity\n  removed.push(eid)\n  enabled[eid] = 0\n\n  // pop swap\n  const index = world[$entityIndices][eid]\n\n  const swapped = world[$entityArray].pop()\n  if (swapped !== eid) {\n    world[$entityArray][index] = swapped\n    world[$entityIndices][swapped] = index\n  }\n  world[$entityIndices][eid] = NONE\n\n  // Clear entity bitmasks\n  for (let i = 0; i < world[$entityMasks].length; i++) world[$entityMasks][i][eid] = 0\n}\n","import { $queryMap } from \"./Query.js\"\nimport { $indexBytes, $indexType, $queryShadow, $serializeShadow, $storeBase, $storeFlattened } from \"./Storage.js\"\nimport { $componentMap, addComponent, hasComponent } from \"./Component.js\"\nimport { $entityArray, $entityEnabled, addEntity } from \"./Entity.js\"\n\nexport const diff = (world, query) => {\n  const q = world[$queryMap].get(query)\n  q.changed.length = 0\n  const flat = q.flatProps\n  for (let i = 0; i < q.entities.length; i++) {\n    const eid = q.entities[i]\n    let dirty = false\n    for (let pid = 0; pid < flat.length; pid++) {\n      const prop = flat[pid]\n      if (ArrayBuffer.isView(prop[eid])) {\n        for (let i = 0; i < prop[eid].length; i++) {\n          if (prop[eid][i] !== prop[eid][$queryShadow][i]) {\n            dirty = true\n            prop[eid][$queryShadow][i] = prop[eid][i]\n          }\n        }\n      } else {\n        if (prop[eid] !== prop[$queryShadow][eid]) {\n          dirty = true\n          prop[$queryShadow][eid] = prop[eid]\n        }\n      }\n    }\n    if (dirty) q.changed.push(eid)\n  }\n  return q.changed\n}\n\nconst canonicalize = (target) => {\n  let componentProps = []\n  let changedProps = new Set()\n  if (Array.isArray(target)) {\n    componentProps = target\n      .map(p => {\n        if (typeof p === 'function' && p.name === 'QueryChanged') {\n          p()[$storeFlattened].forEach(prop => {\n            changedProps.add(prop)\n          })\n          return p()[$storeFlattened]\n        }\n        if (Object.getOwnPropertySymbols(p).includes($storeFlattened)) {\n          return p[$storeFlattened]\n        }\n        if (Object.getOwnPropertySymbols(p).includes($storeBase)) {\n          return p\n        }\n      })\n      .reduce((a,v) => a.concat(v), [])\n  }\n  return [componentProps, changedProps]\n}\n\nexport const defineSerializer = (target, maxBytes = 20_000_000) => {\n  const isWorld = Object.getOwnPropertySymbols(target).includes($componentMap)\n\n  let [componentProps, changedProps] = canonicalize(target)\n\n  // TODO: calculate max bytes based on target\n\n  const buffer = new ArrayBuffer(maxBytes)\n  const view = new DataView(buffer)\n\n  return ents => {\n    if (isWorld) {\n      componentProps = []\n      target[$componentMap].forEach((c, component) => {\n        componentProps.push(...component[$storeFlattened])\n      })\n    }\n    \n    if (Object.getOwnPropertySymbols(ents).includes($componentMap)) {\n      ents = ents[$entityArray]\n    }\n\n    if (!ents.length) return\n\n    let where = 0\n\n    // iterate over component props\n    for (let pid = 0; pid < componentProps.length; pid++) {\n      const prop = componentProps[pid]\n      const diff = changedProps.has(prop)\n      \n      // write pid\n      view.setUint8(where, pid)\n      where += 1\n\n      // save space for entity count\n      const countWhere = where\n      where += 4\n      \n      let count = 0\n      // write eid,val\n      for (let i = 0; i < ents.length; i++) {\n        const eid = ents[i]\n\n        // skip if diffing and no change\n        if (diff && prop[eid] === prop[$serializeShadow][eid]) {\n          continue\n        }\n        \n        count++\n\n        // write eid\n        view.setUint32(where, eid)\n        where += 4\n\n        // if property is an array\n        if (ArrayBuffer.isView(prop[eid])) {\n          const type = prop[eid].constructor.name.replace('Array', '')\n          const indexType = prop[eid][$indexType]\n          const indexBytes = prop[eid][$indexBytes]\n\n          // add space for count of dirty array elements\n          const countWhere2 = where\n          where += 1\n\n          let count2 = 0\n\n          // write index,value\n          for (let i = 0; i < prop[eid].length; i++) {\n            const value = prop[eid][i]\n\n            if (diff && prop[eid][i] === prop[eid][$serializeShadow][i]) {\n              continue\n            }\n\n            // write array index\n            view[`set${indexType}`](where, i)\n            where += indexBytes\n\n            // write value at that index\n            view[`set${type}`](where, value)\n            where += prop[eid].BYTES_PER_ELEMENT\n            count2++\n          }\n\n          // write total element count\n          view[`set${indexType}`](countWhere2, count2)\n\n        } else {\n          // regular property values\n          const type = prop.constructor.name.replace('Array', '')\n          // set value next [type] bytes\n          view[`set${type}`](where, prop[eid])\n          where += prop.BYTES_PER_ELEMENT\n\n          // sync shadow state\n          prop[$serializeShadow][eid] = prop[eid]\n        }\n      }\n\n      view.setUint32(countWhere, count)\n    }\n    return buffer.slice(0, where)\n  }\n}\n\nexport const defineDeserializer = (target) => {\n  const isWorld = Object.getOwnPropertySymbols(target).includes($componentMap)\n  let [componentProps] = canonicalize(target)\n  return (world, packet) => {\n    \n    if (isWorld) {\n      componentProps = []\n      target[$componentMap].forEach((c, component) => {\n        componentProps.push(...component[$storeFlattened])\n      })\n    }\n\n    const view = new DataView(packet)\n    let where = 0\n\n    while (where < packet.byteLength) {\n\n      // pid\n      const pid = view.getUint8(where)\n      where += 1\n\n      // entity count\n      const entityCount = view.getUint32(where)\n      where += 4\n\n      // typed array\n      const ta = componentProps[pid]\n\n      // Get the properties and set the new state\n      for (let i = 0; i < entityCount; i++) {\n        let eid = view.getUint32(where)\n        where += 4\n\n        // if this world hasn't seen this eid yet\n        if (!world[$entityEnabled][eid]) {\n          // make a new entity for the data\n          eid = addEntity(world)\n        }\n\n        const component = ta[$storeBase]()\n        if (!hasComponent(world, component, eid)) {\n          addComponent(world, component, eid)\n        }\n        \n        if (ArrayBuffer.isView(ta[eid])) {\n          const array = ta[eid]\n          const count = view[`get${array[$indexType]}`](where)\n          where += array[$indexBytes]\n\n          // iterate over count\n          for (let i = 0; i < count; i++) {\n            const index = view[`get${array[$indexType]}`](where)\n            where += array[$indexBytes]\n\n            const value = view[`get${array.constructor.name.replace('Array', '')}`](where)\n            where += array.BYTES_PER_ELEMENT\n\n            ta[eid][index] = value\n          }\n        } else {\n          let value = view[`get${ta.constructor.name.replace('Array', '')}`](where)\n          where += ta.BYTES_PER_ELEMENT\n\n          ta[eid] = value\n        }\n      }\n    }\n  }\n}","import { $storeFlattened, $storeSize } from './Storage.js'\nimport { $componentMap, registerComponent } from './Component.js'\nimport { $entityMasks, $entityEnabled, getEntityCursor } from './Entity.js'\nimport { diff } from './Serialize.js'\n\nexport function Not(c) { return function QueryNot() { return c } }\nexport function Changed(c) { return function QueryChanged() { return c } }\n\nexport const $queries = Symbol('queries')\nexport const $queryMap = Symbol('queryMap')\nexport const $dirtyQueries = Symbol('$dirtyQueries')\nexport const $queryComponents = Symbol('queryComponents')\nexport const $enterQuery = Symbol('enterQuery')\nexport const $exitQuery = Symbol('exitQuery')\n\nconst NONE = 2**32\n\n\n// TODO: linked list of functions\nexport const enterQuery = (world, query, fn) => {\n  if (!world[$queryMap].has(query)) registerQuery(world, query)\n  world[$queryMap].get(query).enter = fn\n}\n\nexport const exitQuery = (world, query, fn) => {\n  if (!world[$queryMap].has(query)) registerQuery(world, query)\n  world[$queryMap].get(query).exit = fn\n}\n\nexport const registerQuery = (world, query) => {\n\n  let components = []\n  let notComponents = []\n  let changedComponents = []\n\n  query[$queryComponents].forEach(c => {\n    if (typeof c === 'function') {\n      if (c.name === 'QueryNot') {\n        notComponents.push(c())\n      }\n      if (c.name === 'QueryChanged') {\n        changedComponents.push(c())\n        components.push(c())\n      }\n    } else {\n      components.push(c)\n    }\n  })\n\n  const mapComponents = c => world[$componentMap].get(c)\n\n  const size = components.concat(notComponents).reduce((a,c) => c[$storeSize] > a ? c[$storeSize] : a, 0)\n\n  const entities = []\n  const changed = []\n  const indices = new Uint32Array(size).fill(NONE)\n  const enabled = new Uint8Array(size)\n  const generations = components\n    .concat(notComponents)\n    .map (c => {\n      if (!world[$componentMap].has(c)) registerComponent(world, c)\n      return c\n    })\n    .map(mapComponents)\n    .map(c => c.generationId)\n    .reduce((a,v) => {\n      if (a.includes(v)) return a\n      a.push(v)\n      return a\n    }, [])\n\n  const reduceBitmasks = (a,c) => {\n    if (!a[c.generationId]) a[c.generationId] = 0\n    a[c.generationId] |= c.bitflag\n    return a\n  }\n  const masks = components\n    .map(mapComponents)\n    .reduce(reduceBitmasks, {})\n\n  const notMasks = notComponents\n    .map(mapComponents)\n    .reduce((a,c) => {\n      if (!a[c.generationId]) {\n        a[c.generationId] = 0\n        a[c.generationId] |= c.bitflag\n      }\n      return a\n    }, {})\n\n  const flatProps = components\n    .map(c => Object.getOwnPropertySymbols(c).includes($storeFlattened) ? c[$storeFlattened] : [c])\n    .reduce((a,v) => a.concat(v), [])\n\n  const toRemove = []\n  const entered = []\n  const exited = []\n\n  world[$queryMap].set(query, { \n    entities,\n    changed,\n    enabled,\n    components,\n    notComponents,\n    changedComponents,\n    masks,\n    notMasks,\n    generations,\n    indices,\n    flatProps,\n    toRemove,\n    entered,\n    exited,\n  })\n  \n  world[$queries].add(query)\n\n  for (let eid = 0; eid < getEntityCursor(); eid++) {\n    if (!world[$entityEnabled][eid]) continue\n    if (queryCheckEntity(world, query, eid)) {\n      queryAddEntity(world, query, eid)\n    }\n  }\n}\n\nconst queryHooks = (q) => {\n  while (q.entered.length) if (q.enter) { q.enter(q.entered.shift()) } else q.entered.shift()\n  while (q.exited.length) if (q.exit) { q.exit(q.exited.shift()) } else q.exited.shift()\n}\n\nexport const defineQuery = (components) => {\n  const query = function (world) {\n    if (!world[$queryMap].has(query)) registerQuery(world, query)\n    const q = world[$queryMap].get(query) \n    queryHooks(q)\n    queryCommitRemovals(world, q)\n    if (q.changedComponents.length) return diff(world, query)\n    return q.entities\n  }\n  query[$queryComponents] = components\n  return query\n}\n\n// TODO: archetype graph\nexport const queryCheckEntity = (world, query, eid) => {\n  const { masks, notMasks, generations } = world[$queryMap].get(query)\n  for (let i = 0; i < generations.length; i++) {\n    const generationId = generations[i]\n    const qMask = masks[generationId]\n    const qNotMask = notMasks[generationId]\n    const eMask = world[$entityMasks][generationId][eid]\n    if (qNotMask && (eMask & qNotMask) !== 0) {\n      return false\n    }\n    if (qMask && (eMask & qMask) !== qMask) {\n      return false\n    }\n  }\n  return true\n}\n\nexport const queryCheckComponent = (world, query, component) => {\n  const { generationId, bitflag } = world[$componentMap].get(component)\n  const { masks } = world[$queryMap].get(query)\n  const mask = masks[generationId]\n  return (mask & bitflag) === bitflag\n}\n\nexport const queryAddEntity = (world, query, eid) => {\n  const q = world[$queryMap].get(query)\n  if (q.enabled[eid]) return\n  q.enabled[eid] = true\n  q.entities.push(eid)\n  q.indices[eid] = q.entities.length - 1\n  q.entered.push(eid)\n}\n\nconst queryCommitRemovals = (world, q) => {\n  while (q.toRemove.length) {\n    const eid = q.toRemove.pop()\n    const index = q.indices[eid]\n    if (index === NONE) continue\n\n    const swapped = q.entities.pop()\n    if (swapped !== eid) {\n      q.entities[index] = swapped\n      q.indices[swapped] = index\n    }\n    q.indices[eid] = NONE\n  }\n  world[$dirtyQueries].delete(q)\n}\n\nexport const commitRemovals = (world) => {\n  world[$dirtyQueries].forEach(q => {\n    queryCommitRemovals(world, q)\n  })\n}\n\nexport const queryRemoveEntity = (world, query, eid) => {\n  const q = world[$queryMap].get(query)\n  if (!q.enabled[eid]) return\n  q.enabled[eid] = false\n  q.toRemove.push(eid)\n  world[$dirtyQueries].add(q)\n  q.exited.push(eid)\n}","import { $storeSize, createStore, resetStoreFor, resizeStore } from './Storage.js'\nimport { $queryComponents, $queries, queryAddEntity, queryRemoveEntity, queryCheckEntity, queryCheckComponent } from './Query.js'\nimport { $bitflag, $size } from './World.js'\nimport { $entityMasks } from './Entity.js'\n\nexport const $componentMap = Symbol('componentMap')\n\nexport const defineComponent = (schema) => createStore(schema)\n\nexport const incrementBitflag = (world) => {\n  world[$bitflag] *= 2\n  if (world[$bitflag] >= 2**32) {\n    world[$bitflag] = 1\n    world[$entityMasks].push(new Uint32Array(world[$size]))\n  }\n}\n\nexport const registerComponent = (world, component) => {\n  world[$componentMap].set(component, { \n    generationId: world[$entityMasks].length - 1,\n    bitflag: world[$bitflag],\n    store: component\n  })\n\n  if (component[$storeSize] < world[$size]) {\n    resizeStore(component, world[$size])\n  }\n\n  incrementBitflag(world)\n}\n\nexport const registerComponents = (world, components) => {\n  components.forEach(c => registerComponent(world, c))\n}\n\nexport const hasComponent = (world, component, eid) => {\n  const { generationId, bitflag } = world[$componentMap].get(component)\n  const mask = world[$entityMasks][generationId][eid]\n  return (mask & bitflag) === bitflag\n}\n\nexport const addComponent = (world, component, eid) => {\n  if (!world[$componentMap].has(component)) registerComponent(world, component)\n  if (hasComponent(world, component, eid)) return\n\n  // Add bitflag to entity bitmask\n  const { generationId, bitflag } = world[$componentMap].get(component)\n  world[$entityMasks][generationId][eid] |= bitflag\n\n  // Zero out each property value\n  resetStoreFor(component, eid)\n\n  // todo: archetype graph\n  world[$queries].forEach(query => {\n    if (!queryCheckComponent(world, query, component)) return\n    const match = queryCheckEntity(world, query, eid)\n    if (match) queryAddEntity(world, query, eid)\n  })\n}\n\nexport const removeComponent = (world, component, eid) => {\n  const { generationId, bitflag } = world[$componentMap].get(component)\n\n  if (!(world[$entityMasks][generationId][eid] & bitflag)) return\n\n  // todo: archetype graph\n  world[$queries].forEach(query => {\n    if (!queryCheckComponent(world, query, component)) return\n    const match = queryCheckEntity(world, query, eid)\n    if (match) queryRemoveEntity(world, query, eid)\n  })\n\n  // Remove flag from entity bitmask\n  world[$entityMasks][generationId][eid] &= ~bitflag\n}\n","import { $componentMap } from './Component.js'\nimport { $queryMap, $queries, $dirtyQueries } from './Query.js'\nimport { $entityArray, $entityIndices, $entityEnabled, $entityMasks } from './Entity.js'\n\nexport const $size = Symbol('size')\nexport const $warningSize = Symbol('warningSize')\nexport const $bitflag = Symbol('bitflag')\n\nexport const createWorld = (size = 1000000) => {\n  const world = {}\n  \n  world[$size] = size\n\n  world[$entityEnabled] = new Uint8Array(size)\n  world[$entityMasks] = [new Uint32Array(size)]\n\n  world[$entityArray] = []\n  world[$entityIndices] = new Uint32Array(size)\n\n  world[$bitflag] = 1\n\n  world[$componentMap] = new Map()\n\n  world[$queryMap] = new Map()\n  world[$queries] = new Set()\n  world[$dirtyQueries] = new Set()\n\n  world[$warningSize] = size - (size / 5)\n\n  return world\n}","import { commitRemovals } from './Query.js'\n\nexport const defineSystem = (update) => {\n  const system = world => {\n    update(world)\n    commitRemovals(world)\n    return world\n  }\n\n  Object.defineProperty(system, 'name', {\n    value: (update.name || \"AnonymousSystem\") + \"_internal\",\n    configurable: true,\n  })\n\n  return system\n}","import { createWorld } from './World.js'\nimport { addEntity, removeEntity } from './Entity.js'\nimport { defineComponent, registerComponent, registerComponents, hasComponent, addComponent, removeComponent } from './Component.js'\nimport { defineSystem } from './System.js'\nimport { defineQuery, enterQuery, exitQuery, Changed, Not, commitRemovals } from './Query.js'\nimport { defineSerializer, defineDeserializer } from './Serialize.js'\nimport { TYPES_ENUM } from './Storage.js'\n\nexport const pipe = (...fns) => input => {\n  fns = Array.isArray(fns[0]) ? fns[0] : fns\n  let tmp = input\n  for (let i = 0; i < fns.length; i++) {\n    const fn = fns[i]\n    tmp = fn(tmp)\n  }\n}\n\nexport const Types = TYPES_ENUM\n\nexport {\n\n  createWorld,\n  addEntity,\n  removeEntity,\n\n  registerComponent,\n  registerComponents,\n  defineComponent,\n  addComponent,\n  removeComponent,\n  hasComponent,\n  \n  defineQuery,\n  Changed,\n  Not,\n  enterQuery,\n  exitQuery,\n  commitRemovals,\n\n  defineSystem,\n  \n  defineSerializer,\n  defineDeserializer,\n\n}\n"],"names":["TYPES_ENUM","bool","i8","ui8","ui8c","i16","ui16","i32","ui32","f32","f64","TYPES_NAMES","TYPES","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","UNSIGNED_MAX","uint8","uint16","uint32","roundToMultiple4","x","Math","ceil","$storeRef","Symbol","$storeSize","$storeMaps","$storeFlattened","$storeBase","$storeArrayCount","$storeSubarrays","$storeCursor","$subarrayCursors","$subarray","$queryShadow","$serializeShadow","$indexType","$indexBytes","stores","resize","ta","size","newBuffer","ArrayBuffer","BYTES_PER_ELEMENT","newTa","constructor","set","resizeRecursive","store","Object","keys","forEach","key","isView","resizeSubarrays","cursors","type","arrayCount","length","summedBytesPerElement","Array","fill","reduce","a","p","summedLength","buffer","array","slice","eid","from","to","subarray","resizeStore","resetStoreFor","createTypeStore","totalBytes","createArrayStore","indexType","Error","end","createShadows","isArrayType","isArray","createStore","schema","$store","JSON","parse","stringify","collectArrayCount","count","metadata","recursiveTransform","k","push","assign","$entityMasks","$entityEnabled","$entityArray","$entityIndices","NONE","globalEntityCursor","removed","getEntityCursor","resizeWorld","world","$size","$componentMap","c","$queryMap","q","indices","enabled","i","masks","addEntity","$warningSize","amount","pop","removeEntity","$queries","query","queryRemoveEntity","index","swapped","diff","get","changed","flat","flatProps","entities","dirty","pid","prop","canonicalize","target","componentProps","changedProps","Set","map","name","add","getOwnPropertySymbols","includes","v","concat","defineSerializer","maxBytes","isWorld","view","DataView","ents","component","where","has","setUint8","countWhere","setUint32","replace","indexBytes","countWhere2","count2","value","defineDeserializer","packet","byteLength","getUint8","entityCount","getUint32","hasComponent","addComponent","Not","QueryNot","Changed","QueryChanged","$dirtyQueries","$queryComponents","enterQuery","fn","registerQuery","enter","exitQuery","exit","components","notComponents","changedComponents","mapComponents","generations","registerComponent","generationId","reduceBitmasks","bitflag","notMasks","toRemove","entered","exited","queryCheckEntity","queryAddEntity","queryHooks","shift","defineQuery","queryCommitRemovals","qMask","qNotMask","eMask","queryCheckComponent","mask","delete","commitRemovals","defineComponent","incrementBitflag","$bitflag","registerComponents","match","removeComponent","createWorld","Map","defineSystem","update","system","defineProperty","configurable","pipe","fns","input","tmp","Types"],"mappings":"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"}